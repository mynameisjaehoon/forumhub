---
title: Nginx를 이용한 로드밸런싱
date: 2024-04-28 16:00:00 +09:00
description: >-
    로드밸런싱을 하게 된 이유
categories: [인프라, 로드밸런싱]
tags: [메이플 주문서 시뮬레이터]
---

![CPU 사용률 모니터링 결과](https://github.com/mynameisjaehoon/mynameisjaehoon.github.io/assets/76734067/aa410553-c868-48c9-adf7-724fa3b79956)
스레드, 커넥션 등 여러 최적화 작업을 했음에도 서버 부하테스트의 결과 현재 서버 1개만으로는 목표로하는 트래픽을 감당할 수 없음이 드러났다. 따라서 스케일아웃 으로 서버의 갯수를 늘리고 로드밸런싱을 통해 트래픽을 적절히 분산해주는 방법을 사용하기로 하였다. 다중 서버 환경에서 한 서버에 트래픽이 몰리지 않도록 트래픽을 적절히 분산해주는 작업을 로드밸런싱이라고 한다.

클라우드 환경에서 Nginx를 이용해서 로드밸런싱 환경을 구축하는 과정을 정리해본다. Nginx를 사용해서 로드밸런싱을 수행하는 이유는 사용법이 간단하고 비용이 저렴하기 때문이다. L4, L7 스위치는 직접 장비를 사야하는 등 개인 서버를 운영하는 입장에서는 부담이 크다. Nginx는 소프트웨어만 다운로드 받고 필요한 설정정보만 입력하면 편리하게 운영할 수 있다. 

## Nginx 로드밸런싱 구현

### 도메인 등록
![](https://github.com/mynameisjaehoon/mynameisjaehoon.github.io/assets/76734067/1f7ccac7-93d2-4776-a92c-1ff9160300cb)
로드밸런서가 트래픽을 분산할 두개의 인스턴스를 새로만들고 도메인 주소를 할당해줍니다.
- `dev1.gongnomok.site`
- `dev2.gongnomok.site`

### Nginx 설정정보 작성
```
upstream gongnomok-dev-cluster {
    server dev1.gongnomok.site:8080; # gongnomok-dev-1
    server dev2.gongnomok.site:8080; # gongnomok-dev-2
}

server {
    listen 80;
    server_name dev.gongnomok.site;

    location / {
        return 301 https://dev.gongnomok.site$request_uri;
    }
}

server {
    listen 443 ssl;
    server_name dev.gongnomok.site; 

    ssl_certificate /etc/secret/fullchain-dev.pem; # managed by Certbot
    ssl_certificate_key /etc/secret/privkey-dev.pem; # managed by Certbot
    include /etc/secret/options-ssl-nginx.conf; # managed by Certbot

    location / {
        root   /usr/share/nginx/html;
        index  index.html index.htm;
        try_files $uri $uri/ /index.html;
    }

	location /api {
        proxy_pass http://gongnomok-dev-cluster;
    }

    location /actuator {
        proxy_pass http://gongnomok-dev-cluster;
    }
}
```

### 접속확인
- 사이트에 요청을 보내면 로드밸런서가 요청을 분산시켜 응답을 받아오는 것을 확인할 수 있습니다.
- 또한 모니터링 툴에서도 두개의 인스턴스를 인식하는 것을 확인할 수 있습니다.

![](https://github.com/mynameisjaehoon/mynameisjaehoon.github.io/assets/76734067/740574ac-101e-400c-976d-f57c6f83c9b7)

### 로드밸런싱 알고리즘 종류

로드밸런서가 트래픽을 어떤 방식으로 분산시킬지에 대해서 몇가지 알고리즘이 존재합니다.

|알고리즘|설명|
|:----|:---|
|`라운드 로빈`(기본값)|요청을|
|`least_conn`(최소 연결)||
|`ip_hash`||
|`least_time`||

## Reference
- [**[Velog]** 로드밸런싱 개념 및 구축](https://velog.io/@kimjiwonpg98/Nginx-%EB%A1%9C%EB%93%9C%EB%B0%B8%EB%9F%B0%EC%8B%B1-%EA%B0%9C%EB%85%90-%EB%B0%8F-%EA%B5%AC%EC%B6%95)
- [**[공식문서]** HTTP Load Balancing](https://docs.nginx.com/nginx/admin-guide/load-balancer/http-load-balancer/)
- []()
- []()
- []()
- []()
- []()
- []()