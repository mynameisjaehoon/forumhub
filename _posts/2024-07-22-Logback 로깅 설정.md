---
title: Logback 설정
date: 2024-07-22 18:00:00 +09:00
description: >-
  애플리케이션의 로그를 파일로 기록하고, 발생한 문제를 빠르게 파악하기 위해서 로깅시스템을 구현하였습니다.
categories: [개발, 로깅]
tags: [메이플 주문서 시뮬레이터]
---

## 로깅 시스템 구축의 필요성
지금까지 로그를 하면 공부하거나 개발 과정중에 콘솔로 확인하며 데이터의 흐름을 파악하거나 디버깅하는 용도로 사용했다. 하지만 최근들어 서비스를 사용하는 유저가 많아지면서 적절하지 못한 요청을 보내거나 서버에서 예외가 발생하는 경우가 많아졌다. 문제가 발생했을 때 로그를 따로 저장해두지 않았기 때문에 문제 원인을 파악하기 위해 직접 QA를 해보며 로컬에서 디버깅을 했다. 하지만 문제의 발생횟수가 늘어나자 원인을 파악하는데에 시간을 많이 쏟게 되었고, 내가 파악한 원인이 정답인지도 의심이 생겼다. 또 문제가 발생한 직후 알아차릴 수 없다는 문제도 있었다. 내가 생각이 날때마다 어떤 문제는 없는지 직접 찾아보는 식으로 운영했기 때문에 문제발생 시간 이후 이미 오랜시간이 지난 경우가 많았다. 

로그를 기록해놨다면 문제가 발생한 시점의 로그기록을 보고 정확한 원인을 파악할 수 있었을 것이고 에러 로그가 발생했을 때 슬랙이나 메일로 알림을 받을 수 있었다면 문제가 발생했다는 것을 바로 알아차릴 수 있었을 것이다.

## Logback
스프링 부트 스타터 라이브러리를 프로젝트에 포함시켰다면 기본값으로 Logback을 사용하게 된다. `@Slf4j` 애노테이션을 적용시켰을 때 기본으로 사용할 수 있었던 로그 기능이 Logback 이다. Log4j를 사용하도록 설정할 수 있지만 두 로그 라이브러리의 개발자가 같고, Log4j를 개선시켜 만들어낸 것이 Logback 이기 때문에 특별한 이유가 없다면 기본으로 주어지는 Logback을 사용하게 된다.

### 어떻게 설정하는가
Logback 설정은 `application.properties` 나 `application.yml` 같은 설정파일에서 수행할 수도 있고, `resources` 폴더에 `logback.xml`, `logback-spring.xml` 파일에 세부적인 설정을 할 수 있다.

## 목표
만들어볼 로그 시스템의 목표는 다음과 같다.
- 로그 레벨(INFO, WARN, ERROR) 에 따라 다른 파일로 로그를 기록한다.
- 로그 파일은 하루 단위로 나누어 기록되도록 한다.
- 에러(ERROR) 로그가 발생한 경우 슬랙으로 알림이 오도록 한다. 아래의 정보를 알림 메세지에 포함시킨다.
  - 로그 메세지
  - `REQUEST_ID`
  - `REQUEST_URI`
  - `REQUEST_METHOD`
  - `REQUEST_TIME`
  - `REQUEST_IP`

## logback-spring.xml 파일 작성
`logback-spring.xml` 파일을 resources 폴더에 작성해 Logback의 세부사항을 설정할 수 있다. 

> `logback.xml` 이라는 이름으로 파일을 만들어도 적용할 수 있으나, [스프링부트 로깅 문서](https://docs.spring.io/spring-boot/reference/features/logging.html#features.logging.custom-log-configuration)에는 가능하면 `-spring` 접미사를 붙일 것을 권장하고 있다. 더 유연성이 증가하고, 초기화 순서 관련 문제를 방지해준다고 한다.
> ![](https://github.com/user-attachments/assets/9d8b3175-66e5-4192-89f5-c685ef8e614c)

먼저 내가 작성한 `logback-spring.xml` 스크립트를 먼저 보면서 하나하나 설명해보겠다.

```xml
<!-- logback-spring.xml -->
<?xml version="1.0" encoding="UTF-8"?>

<configuration scan="true">
    <include resource="org/springframework/boot/logging/logback/defaults.xml"/>
    <timestamp key="DATE_PATTERN" datePattern="yyyy-MM-dd" />

    <include resource="console-appender.xml" />
    <include resource="info-appender.xml" />
    <include resource="warn-appender.xml" />
    <include resource="error-appender.xml" />

    <root level="info">
        <appender-ref ref="CONSOLE" />
        <appender-ref ref="FILE-INFO" />
        <appender-ref ref="FILE-WARN" />
        <appender-ref ref="FILE-ERROR" />
        <appender-ref ref="ASYNC_SLACK" />
<!--        <springProfile name="prod">-->
<!--            <appender-ref ref="ASYNC-SLACK" />-->
<!--        </springProfile>-->
    </root>
</configuration>
```
- `<configuration scan="true">`
  - 설정정보 작성을 시작하는 부분입니다.
  - scan 옵션은 설정 파일의 변경사항을 자동으로 감지하여 재 로딩하는 역할을 합니다.
- `<include resource="org/springframework/boot/logging/logback/defaults.xml"/>`
  - 스프링 부트의 기본 로깅 설정을 포함합니다.
- `<timestamp key="DATE_PATTERN" datePattern="yyyy-MM-dd" />`
  - `DATE_PATTERN` 라는 키로 날짜를 `yyyy-MM-dd` 형식으로 저장합니다. 
- `<include resource="..." />`
  - resource 옵션에 적힌 파일을 설정정보에 포함시킵니다.
  - 현재 코드에서는 아래의 파일들이 포함되어 있습니다.
    - 콘솔 로그 출력을 담당하는 `console-appender.xml`
    - `INFO` 레벨 로그 출력을 담당하는 `info-appender.xml`
    - `WARN` 레벨 로그 출력을 담당하는 `warn-appender.xml`
    - `ERROR` 레벨 로그 출력을 담당하는 `error-appender.xml`
- `<root level="info">`
  - 루트 로그 레벨을 INFO로 설정한다.
- Appender 참조
  - 정의해둔 Appender 이름을 사용해서 Appender를 추가한다.

### 로그 콘솔 설정
앞으로 추가할 여러 `XXX-appender.xml` 파일도 전부 `logback-spring.xml` 파일과 같이 `resources` 폴더에 위치시키면 된다.
```xml
<!-- console-appender.xml -->
<included>
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>${CONSOLE_LOG_PATTERN}</pattern>
            <charset>utf8</charset>
        </encoder>
    </appender>
</included>
```

## 참고자료
- [Logback 공식 메뉴얼](https://logback.qos.ch/manual/introduction.html)
